<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador JSON</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Azeret+Mono:ital,wght@0,100..900;1,100..900&family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Fira+Sans+Condensed:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Inconsolata:wght@200..900&family=Noto+Sans+Mono:wght@100..900&family=Source+Code+Pro:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
    <!-- TODO delete -index.css- file. -->
    <link href="static/indexApp.css" type="text/css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Validador de Controles Volum√©tricos</h1>
            <p class="subtitle">Valida el cumplimiento de tu <i><b>reporte mensual</b></i></p>
            <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema">
                <span class="theme-icon">üåô</span>
            </button>
        </div>

        <div class="upload-section">
            <div class="upload-card" id="uploadCard">
                <input type="file" id="jsonFile" class="file-input" accept=".json">
                <div class="upload-icon">üìé</div>
                <div class="upload-title">Selecciona tu archivo JSON</div>
                <div class="upload-description">o arrastra y suelta aqu√≠</div>
                <div class="file-name-display" id="fileNameDisplay" style="display: none;"></div>
            </div>
        </div>

        <div class="content-wrapper" id="contentWrapper" style="display: none;">
            <!-- JSON Section -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">
                        <span class="section-icon">üìÑ</span>
                        <span id="jsonFileName">Contenido del archivo</span>
                    </div>
                    <button class="copy-btn" id="copyBtn">
                        üìã Copiar
                    </button>
                </div>
                <div class="section-content">
                    <div class="json-viewer-wrapper">
                        <div class="json-viewer" id="jsonContent"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="section">
                <div class="section-header">
                    <!-- <div class="section-title">
                        <span class="section-icon">üîç</span>
                        Resultados de validaci√≥n
                    </div> -->
                    <span class="section-badge" id="statusBadge">Validando...</span>
                </div>
                <div class="section-content">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">
        <div class="toast-icon">‚úì</div>
        JSON copiado correctamente
    </div>

    <script>
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        const savedTheme = localStorage.getItem('theme') || 'dark';
        html.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });

        function updateThemeIcon(theme) {
            const icon = themeToggle.querySelector('.theme-icon');
            icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        let currentJSON = null;
        const uploadCard = document.getElementById('uploadCard');
        const fileInput = document.getElementById('jsonFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // Upload interactions
        uploadCard.addEventListener('click', () => fileInput.click());

        uploadCard.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadCard.classList.add('dragover');
        });

        uploadCard.addEventListener('dragleave', () => {
            uploadCard.classList.remove('dragover');
        });

        uploadCard.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadCard.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/json') {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        async function handleFile(file) {
            // Show file name
            fileNameDisplay.textContent = `üìÑ ${file.name}`;
            fileNameDisplay.style.display = 'inline-block';
            
            try {
                const text = await file.text();
                const texT = text
                    .replace(/:\s*NaN\s*([,\}])/g, ': "NaN"$1')
                    .replace(/:\s*Infinity\s*([,\}])/g, ': "Infinity"$1')
                    .replace(/:\s*-Infinity\s*([,\}])/g, ': "-Infinity"$1')
                    .replace(/:\s*undefined\s*([,\}])/g, ': "undefined"$1');

                currentJSON = JSON.parse(texT)

                document.getElementById('jsonFileName').textContent = file.name;
                displayJSON(currentJSON);
                document.getElementById('contentWrapper').style.display = 'flex';

                // API call
                let formData = new FormData();
                formData.append("file", file);

                let response = await fetch("/upload/", {
                    method: "POST",
                    body: formData
                });
                let result = await response.json();

                // Manejar diferentes tipos de respuesta
                let errors = [];
                if (Array.isArray(result)) {
                    errors = result;
                } else if (result && Array.isArray(result.errors)) {
                    errors = result.errors;
                } else if (result && result.error) {
                    errors = [{ type_error: 'Error', error: result.error }];
                }

                displayResults(errors);

            } catch (error) {
                console.error('Error:', error);
                displayError(error.message);
            }
        }

        const INVALID_VALUE_REPLACEMENT = "Valor NaN no valido";
        let nanValuesCount = 0;

        function sanitizeRawJsonString(jsonString) {
            return jsonString
                .replace(/:\s*NaN/g, `: "${INVALID_VALUE_REPLACEMENT}"`)
                .replace(/:\s*Infinity/g, `: "${INVALID_VALUE_REPLACEMENT}"`)
                .replace(/:\s*-Infinity/g, `: "${INVALID_VALUE_REPLACEMENT}"`)
                .replace(/:\s*undefined/g, `: "${INVALID_VALUE_REPLACEMENT}"`)
                .replace(/"\s*NaN\s*"/g, `"${INVALID_VALUE_REPLACEMENT}"`)
                .replace(/"\s*Infinity\s*"/g, `"${INVALID_VALUE_REPLACEMENT}"`)
                .replace(/"\s*-Infinity\s*"/g, `"${INVALID_VALUE_REPLACEMENT}"`);
        }

        function countNanValuesInString(jsonString) {
            const nanMatches = [
                ...jsonString.matchAll(/:\s*NaN/g),
                ...jsonString.matchAll(/:\s*Infinity/g),
                ...jsonString.matchAll(/:\s*-Infinity/g),
                ...jsonString.matchAll(/:\s*undefined/g),
                ...jsonString.matchAll(/"\s*NaN\s*"/g),
                ...jsonString.matchAll(/"\s*Infinity\s*"/g),
                ...jsonString.matchAll(/"\s*-Infinity\s*"/g)
            ];
            return nanMatches.length;
        }

        function displayJSON(json) {
            let formatted = JSON.stringify(json, null, 2);

            // Contar valores NaN antes de sanitizar
            nanValuesCount = countNanValuesInString(formatted);

            // Sanitizar el JSON
            if (nanValuesCount > 0) {
                formatted = sanitizeRawJsonString(formatted);
            }

            const highlighted = syntaxHighlight(formatted);
            document.getElementById('jsonContent').innerHTML = highlighted;

            // Actualizar el badge si hay sanitizaci√≥n
            if (nanValuesCount > 0) {
                const statusBadge = document.getElementById('statusBadge');
                const originalText = statusBadge.textContent;
                statusBadge.innerHTML = `
                    <span style="margin-right: 8px;"> ${nanValuesCount} valor${nanValuesCount > 1 ? 'es' : ''} sanitizado${nanValuesCount > 1 ? 's' : ''}</span>
                `;
                statusBadge.style.background = 'rgba(251, 191, 36, 0.2)';
                statusBadge.style.color = '#fbbf24';
            }
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            const colors = ['#FF6188', '#FC9867', '#FFD866', '#A9DC76', '#78DCE8', '#AB9DF2'];

            let colorStack = [];
            let depth = 0;

            return json.replace(/("(\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"\n])*"(:)?|\b(true|false|null)\b|\b-?\d+(\.\d+)?([eE][+\-]?\d+)?\b|{|}|\[|\])/g, function (match) {
                let cls = 'hljs-number';

                // Si es una llave de apertura ( { o [ )
                if (match === '{' || match === '[') {
                    cls = 'hljs-brace';
                    // Determinar el color basado en la profundidad
                    let color = colors[depth % colors.length];
                    // A√±adir el color a la pila
                    colorStack.push(color);
                    // Aumentamos la profundidad
                    depth++;
                    return `<span class="${cls}" style="color: ${color};">${match}</span>`;
                }

                // Si es una llave de cierre ( } o ] )
                if (match === '}' || match === ']') {
                    cls = 'hljs-brace';
                    // Extraer el color de la pila
                    let color = colorStack.pop();
                    // Disminuimos la profundidad
                    depth--;
                    return `<span class="${cls}" style="color: ${color};">${match}</span>`;
                }

                // Si es una clave (entre comillas seguida de :)
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'hljs-keyword'; /* Claves - blanco */
                    } else {
                        cls = 'hljs-string'; /* Strings - amarillo */
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'hljs-literal';
                } else if (/null/.test(match)) {
                    cls = 'hljs-literal';
                } else if (/^-?\d+(\.\d+)?([eE][+\-]?\d+)?$/.test(match)) {
                    cls = 'hljs-number';
                }

                return `<span class="${cls}">${match}</span>`;
            });
        }

        /**
         * Navega hacia un elemento espec√≠fico del JSON basado en un path
         */
        function navigateToJsonElement(sourcePath) {
            if (!sourcePath || !currentJSON) {
                console.warn('No se puede navegar: path o JSON no disponible');
                return;
            }

            try {
                const value = getValueFromPath(currentJSON, sourcePath);

                if (value === undefined) {
                    console.warn('No se encontr√≥ el elemento en el path:', sourcePath);
                    showToast('No se pudo localizar el elemento', 'warning');
                    return;
                }
                if (value === sanitizeRawJsonString(value)) {
                    showToast('El valor es NaN o inv√°lido y fue sanitizado', 'warning');
                    return;
                }

                const jsonContent = document.getElementById('jsonContent');
                const found = highlightValueInDOM(jsonContent, value, sourcePath);

                if (found) {
                    showToast('Elemento localizado', 'success');
                } else {
                    showToast('No se pudo resaltar el elemento', 'warning');
                }

            } catch (error) {
                console.error('Error al navegar:', error);
                showToast('Error al localizar elemento', 'error');
            }
        }

        /**
         * Obtiene el valor de un objeto siguiendo un path
         */
        function getValueFromPath(obj, path) {
            const parts = path.split('.').flatMap(part => {
                const matches = part.match(/([^\[]+)|\[(\d+)\]/g);
                return matches ? matches.map(m => m.replace(/[\[\]]/g, '')) : [part];
            });

            let current = obj;

            for (const part of parts) {
                if (current === null || current === undefined) {
                    return undefined;
                }

                if (!isNaN(part) && Array.isArray(current)) {
                    current = current[parseInt(part)];
                } else {
                    current = current[part];
                }
            }

            return current;
        }

        /**
         * Resalta un valor espec√≠fico en el DOM del JSON renderizado
         */
        function highlightValueInDOM(container, targetValue, sourcePath) {
            const previousHighlights = container.querySelectorAll('.json-highlight');
            previousHighlights.forEach(el => {
                el.classList.remove('json-highlight');
            });

            const keyName = sourcePath.split('.').pop().replace(/\[\d+\]/g, '');
            const valueStr = JSON.stringify(targetValue).replace(/^"|"$/g, '');

            const allSpans = container.querySelectorAll('span');
            let found = false;

            for (let i = 0; i < allSpans.length; i++) {
                const span = allSpans[i];
                const text = span.textContent.trim();

                if (text === `"${keyName}":` || text === `"${keyName}"`) {
                    for (let j = i + 1; j < Math.min(i + 5, allSpans.length); j++) {
                        const valueSpan = allSpans[j];
                        const valueText = valueSpan.textContent.trim().replace(/^"|"$/g, '');

                        if (valueText === valueStr) {
                            valueSpan.classList.add('json-highlight');
                            valueSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            found = true;
                            break;
                        }
                    }

                    if (found) break;
                }
            }

            return found;
        }

        function displayResults(errors) {
            const resultsDiv = document.getElementById('resultsContent');
            const statusBadge = document.getElementById('statusBadge');

            // Asegurar que errors sea un array
            if (!Array.isArray(errors)) {
                console.error('La respuesta no es un array:', errors);
                errors = [];
            }

            if (errors.length === 0) {
                statusBadge.textContent = 'Sin errores';
                statusBadge.style.background = 'rgba(52, 211, 153, 0.2)';
                statusBadge.style.color = '#059669';

                resultsDiv.innerHTML = `
                    <div class="success-card">
                        <div class="success-icon-wrapper">
                            <span class="success-icon">‚úì</span>
                        </div>
                        <div class="success-title">Validaci√≥n exitosa</div>
                        <div class="success-message">No se encontraron motivos de rechazo en el JSON.</div>
                    </div>
                `;
            } else {
                statusBadge.textContent = `${errors.length} error${errors.length > 1 ? 'es' : ''} encontrado${errors.length > 1 ? 's' : ''}`;
                statusBadge.style.background = 'rgba(248, 113, 113, 0.2)';
                statusBadge.style.color = '#fca5a5';

                let errorsHTML = '<div class="error-list">';

                errors.forEach((error, index) => {
                    const hasSource = error.source && error.source.trim() !== '' && error.source != 'Objeto no encontrado.';

                    errorsHTML += `
                        <div class="error-card" style="animation-delay: ${index * 0.1}s">
                            <div class="error-content">
                                <div class="error-type">${error.type_error}</div>
                                <div class="error-message">${error.error}</div>
                                ${hasSource ? `
                                    <!-- <div class="error-source">${error.source}</div> -->
                                    <button class="error-navigate-btn" onclick="navigateToJsonElement('${error.source}')" type="button">
                                        Ir a elemento
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                errorsHTML += '</div>';
                resultsDiv.innerHTML = errorsHTML;
            }
        }

        function displayError(message) {
            const resultsDiv = document.getElementById('resultsContent');
            const statusBadge = document.getElementById('statusBadge');

            statusBadge.textContent = 'Error al procesar';
            statusBadge.style.background = 'rgba(248, 113, 113, 0.2)';
            statusBadge.style.color = '#fca5a5';

            resultsDiv.innerHTML = `
                <div class="error-card">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-content">
                        <div class="error-type">Error de formato</div>
                        <div class="error-message">${message}</div>
                    </div>
                </div>
            `;

            document.getElementById('contentWrapper').style.display = 'flex';
        }

        document.getElementById('copyBtn').addEventListener('click', () => {
            if (currentJSON) {
                const jsonString = JSON.stringify(currentJSON, null, 2);
                navigator.clipboard.writeText(jsonString).then(() => {
                    showToast('‚úì JSON copiado correctamente', 'success');
                });
            }
        });

        function showToast(message = '‚úì JSON copiado correctamente', type = 'success') {
            const toast = document.getElementById('toast');

            toast.innerHTML = `
                <div class="toast-icon">${type === 'success' ? '‚úì' : type === 'warning' ? 'X' : '‚ùå'}</div>
                ${message}
            `;

            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>